-- Fetal measurements table
CREATE TABLE fetal_measurements (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  child_id UUID REFERENCES children(id),
  measured_at DATE NOT NULL DEFAULT CURRENT_DATE,
  week INT NOT NULL CHECK (week BETWEEN 8 AND 42),
  bpd_mm NUMERIC(5,1),
  fl_mm NUMERIC(5,1),
  ac_mm NUMERIC(5,1),
  hc_mm NUMERIC(5,1),
  efw_g NUMERIC(7,1),
  heart_rate_bpm INT,
  memo TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE fetal_measurements ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage own fetal measurements" ON fetal_measurements
  FOR ALL USING (auth.uid() = user_id);

CREATE INDEX idx_fetal_measurements_user ON fetal_measurements(user_id);
CREATE INDEX idx_fetal_measurements_child ON fetal_measurements(child_id);

-- Fetal growth standards table
CREATE TABLE fetal_growth_standards (
  id SERIAL PRIMARY KEY,
  week INT NOT NULL,
  metric TEXT NOT NULL,
  p3 NUMERIC(7,1),
  p10 NUMERIC(7,1),
  p25 NUMERIC(7,1),
  p50 NUMERIC(7,1),
  p75 NUMERIC(7,1),
  p90 NUMERIC(7,1),
  p97 NUMERIC(7,1),
  source TEXT DEFAULT 'WHO/Hadlock'
);

CREATE INDEX idx_fetal_growth_standards_week ON fetal_growth_standards(week);

-- Insert growth standards data (12-40 weeks, 6 metrics)
-- Scaling: p3=p50*0.82, p10=p50*0.87, p25=p50*0.93, p75=p50*1.07, p90=p50*1.13, p97=p50*1.18

INSERT INTO fetal_growth_standards (week, metric, p3, p10, p25, p50, p75, p90, p97) VALUES
-- BPD (mm): 12w=20, 13=22.5, 14=25, 15=27.5, 16=34, 17=36.5, 18=39, 19=41.5, 20=47, 21=49.5, 22=52, 23=54.5, 24=59, 25=62, 26=65, 27=68, 28=72, 29=74, 30=76, 31=79, 32=82, 33=84, 34=85.5, 35=87, 36=88, 37=89.5, 38=91, 39=92.5, 40=94
(12,'bpd_mm',16.4,17.4,18.6,20.0,21.4,22.6,23.6),
(13,'bpd_mm',18.5,19.6,20.9,22.5,24.1,25.4,26.6),
(14,'bpd_mm',20.5,21.8,23.3,25.0,26.8,28.3,29.5),
(15,'bpd_mm',22.6,23.9,25.6,27.5,29.4,31.1,32.5),
(16,'bpd_mm',27.9,29.6,31.6,34.0,36.4,38.4,40.1),
(17,'bpd_mm',29.9,31.8,34.0,36.5,39.1,41.2,43.1),
(18,'bpd_mm',32.0,33.9,36.3,39.0,41.7,44.1,46.0),
(19,'bpd_mm',34.0,36.1,38.6,41.5,44.4,46.9,49.0),
(20,'bpd_mm',38.5,40.9,43.7,47.0,50.3,53.1,55.5),
(21,'bpd_mm',40.6,43.1,46.0,49.5,53.0,55.9,58.4),
(22,'bpd_mm',42.6,45.2,48.4,52.0,55.6,58.8,61.4),
(23,'bpd_mm',44.7,47.4,50.7,54.5,58.3,61.6,64.3),
(24,'bpd_mm',48.4,51.3,54.9,59.0,63.1,66.7,69.6),
(25,'bpd_mm',50.8,53.9,57.7,62.0,66.3,70.1,73.2),
(26,'bpd_mm',53.3,56.6,60.5,65.0,69.6,73.5,76.7),
(27,'bpd_mm',55.8,59.2,63.2,68.0,72.8,76.8,80.2),
(28,'bpd_mm',59.0,62.6,67.0,72.0,77.0,81.4,85.0),
(29,'bpd_mm',60.7,64.4,68.8,74.0,79.2,83.6,87.3),
(30,'bpd_mm',62.3,66.1,70.7,76.0,81.3,85.9,89.7),
(31,'bpd_mm',64.8,68.7,73.5,79.0,84.5,89.3,93.2),
(32,'bpd_mm',67.2,71.3,76.3,82.0,87.7,92.7,96.8),
(33,'bpd_mm',68.9,73.1,78.1,84.0,89.9,94.9,99.1),
(34,'bpd_mm',70.1,74.4,79.5,85.5,91.5,96.6,100.9),
(35,'bpd_mm',71.3,75.7,80.9,87.0,93.1,98.3,102.7),
(36,'bpd_mm',72.2,76.6,81.8,88.0,94.2,99.4,103.8),
(37,'bpd_mm',73.4,77.9,83.2,89.5,95.8,101.1,105.6),
(38,'bpd_mm',74.6,79.2,84.6,91.0,97.4,102.8,107.4),
(39,'bpd_mm',75.9,80.5,86.0,92.5,99.0,104.5,109.2),
(40,'bpd_mm',77.1,81.8,87.4,94.0,100.6,106.2,110.9),

-- FL (mm): 12=8, 13=10.5, 14=13, 15=16.5, 16=20, 17=23, 18=26, 19=29.5, 20=33, 21=35.5, 22=38, 23=40.5, 24=43, 25=45.5, 26=48, 27=50.5, 28=53, 29=55.5, 30=58, 31=60.5, 32=63, 33=65, 34=67, 35=68.5, 36=70, 37=71.5, 38=73, 39=74.5, 40=76
(12,'fl_mm',6.6,7.0,7.4,8.0,8.6,9.0,9.4),
(13,'fl_mm',8.6,9.1,9.8,10.5,11.2,11.9,12.4),
(14,'fl_mm',10.7,11.3,12.1,13.0,13.9,14.7,15.3),
(15,'fl_mm',13.5,14.4,15.3,16.5,17.7,18.6,19.5),
(16,'fl_mm',16.4,17.4,18.6,20.0,21.4,22.6,23.6),
(17,'fl_mm',18.9,20.0,21.4,23.0,24.6,26.0,27.1),
(18,'fl_mm',21.3,22.6,24.2,26.0,27.8,29.4,30.7),
(19,'fl_mm',24.2,25.7,27.4,29.5,31.6,33.3,34.8),
(20,'fl_mm',27.1,28.7,30.7,33.0,35.3,37.3,38.9),
(21,'fl_mm',29.1,30.9,33.0,35.5,38.0,40.1,41.9),
(22,'fl_mm',31.2,33.1,35.3,38.0,40.7,42.9,44.8),
(23,'fl_mm',33.2,35.2,37.7,40.5,43.3,45.8,47.8),
(24,'fl_mm',35.3,37.4,40.0,43.0,46.0,48.6,50.7),
(25,'fl_mm',37.3,39.6,42.3,45.5,48.7,51.4,53.7),
(26,'fl_mm',39.4,41.8,44.6,48.0,51.4,54.2,56.6),
(27,'fl_mm',41.4,43.9,47.0,50.5,54.0,57.1,59.6),
(28,'fl_mm',43.5,46.1,49.3,53.0,56.7,59.9,62.5),
(29,'fl_mm',45.5,48.3,51.6,55.5,59.4,62.7,65.5),
(30,'fl_mm',47.6,50.5,53.9,58.0,62.1,65.5,68.4),
(31,'fl_mm',49.6,52.6,56.3,60.5,64.7,68.4,71.4),
(32,'fl_mm',51.7,54.8,58.6,63.0,67.4,71.2,74.3),
(33,'fl_mm',53.3,56.6,60.5,65.0,69.6,73.5,76.7),
(34,'fl_mm',54.9,58.3,62.3,67.0,71.7,75.7,79.1),
(35,'fl_mm',56.2,59.6,63.7,68.5,73.3,77.4,80.8),
(36,'fl_mm',57.4,60.9,65.1,70.0,74.9,79.1,82.6),
(37,'fl_mm',58.6,62.2,66.5,71.5,76.5,80.8,84.4),
(38,'fl_mm',59.9,63.5,67.9,73.0,78.1,82.5,86.1),
(39,'fl_mm',61.1,64.8,69.3,74.5,79.7,84.2,87.9),
(40,'fl_mm',62.3,66.1,70.7,76.0,81.3,85.9,89.7),

-- HC (mm): 12=70, 13=80, 14=90, 15=105, 16=120, 17=133, 18=147, 19=161, 20=175, 21=186, 22=197, 23=208, 24=219, 25=230, 26=241, 27=252, 28=262, 29=271, 30=280, 31=288, 32=296, 33=303, 34=308, 35=313, 36=318, 37=322, 38=326, 39=330, 40=335
(12,'hc_mm',57.4,60.9,65.1,70.0,74.9,79.1,82.6),
(13,'hc_mm',65.6,69.6,74.4,80.0,85.6,90.4,94.4),
(14,'hc_mm',73.8,78.3,83.7,90.0,96.3,101.7,106.2),
(15,'hc_mm',86.1,91.4,97.7,105.0,112.4,118.7,123.9),
(16,'hc_mm',98.4,104.4,111.6,120.0,128.4,135.6,141.6),
(17,'hc_mm',109.1,115.7,123.7,133.0,142.3,150.3,156.9),
(18,'hc_mm',120.5,127.9,136.7,147.0,157.3,166.1,173.5),
(19,'hc_mm',132.0,140.1,149.7,161.0,172.3,181.9,190.0),
(20,'hc_mm',143.5,152.3,162.8,175.0,187.3,197.8,206.5),
(21,'hc_mm',152.5,161.8,173.0,186.0,199.0,210.2,219.5),
(22,'hc_mm',161.5,171.4,183.2,197.0,210.8,222.6,232.5),
(23,'hc_mm',170.6,181.0,193.4,208.0,222.6,235.0,245.4),
(24,'hc_mm',179.6,190.5,203.7,219.0,234.3,247.5,258.4),
(25,'hc_mm',188.6,200.1,213.9,230.0,246.1,259.9,271.4),
(26,'hc_mm',197.6,209.7,224.1,241.0,257.9,272.3,284.4),
(27,'hc_mm',206.6,219.2,234.4,252.0,269.6,284.8,297.4),
(28,'hc_mm',214.8,227.9,243.7,262.0,280.3,296.1,309.2),
(29,'hc_mm',222.2,235.8,252.0,271.0,290.0,306.2,319.8),
(30,'hc_mm',229.6,243.6,260.4,280.0,299.6,316.4,330.4),
(31,'hc_mm',236.2,250.6,267.8,288.0,308.2,325.4,339.8),
(32,'hc_mm',242.7,257.5,275.3,296.0,316.7,334.5,349.3),
(33,'hc_mm',248.5,263.6,281.8,303.0,324.2,342.4,357.5),
(34,'hc_mm',252.6,267.9,286.4,308.0,329.6,348.0,363.4),
(35,'hc_mm',256.7,272.3,291.1,313.0,334.9,353.7,369.3),
(36,'hc_mm',260.8,276.7,295.7,318.0,340.3,359.3,375.2),
(37,'hc_mm',264.0,280.1,299.5,322.0,344.5,363.9,380.0),
(38,'hc_mm',267.3,283.6,303.2,326.0,348.8,368.4,384.7),
(39,'hc_mm',270.6,287.1,307.0,330.0,353.1,372.9,389.4),
(40,'hc_mm',274.7,291.5,311.6,335.0,358.5,378.6,395.3),

-- AC (mm): 12=56, 13=62, 14=68, 15=85, 16=102, 17=113, 18=124, 19=134, 20=144, 21=157, 22=170, 23=184, 24=197, 25=208, 26=219, 27=230, 28=240, 29=251, 30=261, 31=272, 32=282, 33=292, 34=300, 35=309, 36=318, 37=326, 38=334, 39=342, 40=350
(12,'ac_mm',45.9,48.7,52.1,56.0,59.9,63.3,66.1),
(13,'ac_mm',50.8,53.9,57.7,62.0,66.3,70.1,73.2),
(14,'ac_mm',55.8,59.2,63.2,68.0,72.8,76.8,80.2),
(15,'ac_mm',69.7,74.0,79.1,85.0,90.9,96.1,100.3),
(16,'ac_mm',83.6,88.7,94.9,102.0,109.1,115.3,120.4),
(17,'ac_mm',92.7,98.3,105.1,113.0,120.9,127.7,133.3),
(18,'ac_mm',101.7,107.9,115.3,124.0,132.7,140.1,146.3),
(19,'ac_mm',109.9,116.6,124.6,134.0,143.4,151.4,158.1),
(20,'ac_mm',118.1,125.3,133.9,144.0,154.1,162.7,170.0),
(21,'ac_mm',128.7,136.6,146.0,157.0,168.0,177.4,185.3),
(22,'ac_mm',139.4,147.9,158.1,170.0,181.9,192.1,200.6),
(23,'ac_mm',150.9,160.1,171.1,184.0,196.9,207.9,217.1),
(24,'ac_mm',161.5,171.4,183.2,197.0,210.8,222.6,232.5),
(25,'ac_mm',170.6,181.0,193.4,208.0,222.6,235.0,245.4),
(26,'ac_mm',179.6,190.5,203.7,219.0,234.3,247.5,258.4),
(27,'ac_mm',188.6,200.1,213.9,230.0,246.1,259.9,271.4),
(28,'ac_mm',196.8,208.8,223.2,240.0,256.8,271.2,283.2),
(29,'ac_mm',205.8,218.4,233.4,251.0,268.6,283.6,296.2),
(30,'ac_mm',214.0,227.1,242.7,261.0,279.3,294.9,308.0),
(31,'ac_mm',223.0,236.6,252.9,272.0,291.1,307.4,321.0),
(32,'ac_mm',231.2,245.3,262.3,282.0,301.7,318.7,332.8),
(33,'ac_mm',239.4,254.0,271.6,292.0,312.4,330.0,344.6),
(34,'ac_mm',246.0,261.0,279.0,300.0,321.0,339.0,354.0),
(35,'ac_mm',253.4,268.8,287.4,309.0,330.6,349.2,364.6),
(36,'ac_mm',260.8,276.7,295.7,318.0,340.3,359.3,375.2),
(37,'ac_mm',267.3,283.6,303.2,326.0,348.8,368.4,384.7),
(38,'ac_mm',273.9,290.6,310.6,334.0,357.4,377.4,394.1),
(39,'ac_mm',280.4,297.6,318.1,342.0,365.9,386.5,403.6),
(40,'ac_mm',287.0,304.5,325.5,350.0,374.5,395.5,413.0),

-- EFW (g): 12=14, 13=23, 14=43, 15=70, 16=100, 17=140, 18=190, 19=240, 20=300, 21=360, 22=430, 23=500, 24=600, 25=660, 26=760, 27=875, 28=1000, 29=1150, 30=1320, 31=1500, 32=1700, 33=1920, 34=2150, 35=2380, 36=2600, 37=2860, 38=3080, 39=3250, 40=3400
(12,'efw_g',11.5,12.2,13.0,14.0,15.0,15.8,16.5),
(13,'efw_g',18.9,20.0,21.4,23.0,24.6,26.0,27.1),
(14,'efw_g',35.3,37.4,40.0,43.0,46.0,48.6,50.7),
(15,'efw_g',57.4,60.9,65.1,70.0,74.9,79.1,82.6),
(16,'efw_g',82.0,87.0,93.0,100.0,107.0,113.0,118.0),
(17,'efw_g',114.8,121.8,130.2,140.0,149.8,158.2,165.2),
(18,'efw_g',155.8,165.3,176.7,190.0,203.3,214.7,224.2),
(19,'efw_g',196.8,208.8,223.2,240.0,256.8,271.2,283.2),
(20,'efw_g',246.0,261.0,279.0,300.0,321.0,339.0,354.0),
(21,'efw_g',295.2,313.2,334.8,360.0,385.2,406.8,424.8),
(22,'efw_g',352.6,374.1,399.9,430.0,460.1,485.9,507.4),
(23,'efw_g',410.0,435.0,465.0,500.0,535.0,565.0,590.0),
(24,'efw_g',492.0,522.0,558.0,600.0,642.0,678.0,708.0),
(25,'efw_g',541.2,574.2,613.8,660.0,706.2,745.8,778.8),
(26,'efw_g',623.2,661.2,706.8,760.0,813.2,858.8,896.8),
(27,'efw_g',717.5,761.3,813.8,875.0,936.3,988.8,1032.5),
(28,'efw_g',820.0,870.0,930.0,1000.0,1070.0,1130.0,1180.0),
(29,'efw_g',943.0,1000.5,1069.5,1150.0,1230.5,1299.5,1357.0),
(30,'efw_g',1082.4,1148.4,1227.6,1320.0,1412.4,1491.6,1557.6),
(31,'efw_g',1230.0,1305.0,1395.0,1500.0,1605.0,1695.0,1770.0),
(32,'efw_g',1394.0,1479.0,1581.0,1700.0,1819.0,1921.0,2006.0),
(33,'efw_g',1574.4,1670.4,1785.6,1920.0,2054.4,2169.6,2265.6),
(34,'efw_g',1763.0,1870.5,1999.5,2150.0,2300.5,2429.5,2537.0),
(35,'efw_g',1951.6,2070.6,2213.4,2380.0,2546.6,2689.4,2808.4),
(36,'efw_g',2132.0,2262.0,2418.0,2600.0,2782.0,2938.0,3068.0),
(37,'efw_g',2345.2,2488.2,2659.8,2860.0,3060.2,3231.8,3374.8),
(38,'efw_g',2525.6,2679.6,2864.4,3080.0,3295.6,3480.4,3634.4),
(39,'efw_g',2665.0,2827.5,3022.5,3250.0,3477.5,3672.5,3835.0),
(40,'efw_g',2788.0,2958.0,3162.0,3400.0,3638.0,3842.0,4012.0),

-- Heart Rate (bpm): 12=170, 13=167, 14=164, 15=160, 16=150, 17=147, 18=144, 19=142, 20=140, 21=140, 22=140, 23=140, 24=140, 25=140, 26=140, 27=140, 28=140, 29=139, 30=138, 31=137, 32=137, 33=136, 34=136, 35=135, 36=135, 37=134, 38=133, 39=132, 40=130
(12,'heart_rate_bpm',139.4,147.9,158.1,170.0,181.9,192.1,200.6),
(13,'heart_rate_bpm',136.9,145.2,155.3,167.0,178.7,188.7,197.1),
(14,'heart_rate_bpm',134.5,142.7,152.5,164.0,175.5,185.3,193.5),
(15,'heart_rate_bpm',131.2,139.2,148.8,160.0,171.2,180.8,188.8),
(16,'heart_rate_bpm',123.0,130.5,139.5,150.0,160.5,169.5,177.0),
(17,'heart_rate_bpm',120.5,127.9,136.7,147.0,157.3,166.1,173.5),
(18,'heart_rate_bpm',118.1,125.3,133.9,144.0,154.1,162.7,170.0),
(19,'heart_rate_bpm',116.4,123.5,132.1,142.0,151.9,160.5,167.6),
(20,'heart_rate_bpm',114.8,121.8,130.2,140.0,149.8,158.2,165.2),
(21,'heart_rate_bpm',114.8,121.8,130.2,140.0,149.8,158.2,165.2),
(22,'heart_rate_bpm',114.8,121.8,130.2,140.0,149.8,158.2,165.2),
(23,'heart_rate_bpm',114.8,121.8,130.2,140.0,149.8,158.2,165.2),
(24,'heart_rate_bpm',114.8,121.8,130.2,140.0,149.8,158.2,165.2),
(25,'heart_rate_bpm',114.8,121.8,130.2,140.0,149.8,158.2,165.2),
(26,'heart_rate_bpm',114.8,121.8,130.2,140.0,149.8,158.2,165.2),
(27,'heart_rate_bpm',114.8,121.8,130.2,140.0,149.8,158.2,165.2),
(28,'heart_rate_bpm',114.8,121.8,130.2,140.0,149.8,158.2,165.2),
(29,'heart_rate_bpm',114.0,120.9,129.3,139.0,148.7,157.1,164.0),
(30,'heart_rate_bpm',113.2,120.1,128.3,138.0,147.7,155.9,162.8),
(31,'heart_rate_bpm',112.3,119.2,127.4,137.0,146.6,154.8,161.7),
(32,'heart_rate_bpm',112.3,119.2,127.4,137.0,146.6,154.8,161.7),
(33,'heart_rate_bpm',111.5,118.3,126.5,136.0,145.5,153.7,160.5),
(34,'heart_rate_bpm',111.5,118.3,126.5,136.0,145.5,153.7,160.5),
(35,'heart_rate_bpm',110.7,117.5,125.6,135.0,144.5,152.6,159.3),
(36,'heart_rate_bpm',110.7,117.5,125.6,135.0,144.5,152.6,159.3),
(37,'heart_rate_bpm',109.9,116.6,124.6,134.0,143.4,151.4,158.1),
(38,'heart_rate_bpm',109.1,115.7,123.7,133.0,142.3,150.3,156.9),
(39,'heart_rate_bpm',108.2,114.8,122.8,132.0,141.2,149.2,155.8),
(40,'heart_rate_bpm',106.6,113.1,120.9,130.0,139.1,146.9,153.4);
